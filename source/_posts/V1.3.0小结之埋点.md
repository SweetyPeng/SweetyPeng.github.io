---
title: V1.3.0小结之埋点
date: 2019-01-11 17:30:20
tags: [keep learning,Summary]
categories: 工作小结
copyright: true
---
### About
1.3.0在业务上新增了一个大类，而在此次版本中，我主要负责 小程序首页贝安学堂模块的改造，以及其他一些的优化。

### Task
#### 埋点读研
<!--   MORE  -->
- 需求：要求统计文章的点击数pv、用户数uv、以及阅读时间
- 实现：主要在业务接口内埋点，将埋点信息作为一个字符串，加在post参数内，记录在服务器的接口访问日志上。
- 关于埋点，网上有很多资料，自己也去仔细了解了一下。这里有几个 感觉还不错的资料：

[埋点方案概述-迭代升级](https://blog.csdn.net/hotmoy121/article/details/79902176)

[前端埋点的那些事](https://www.imooc.com/article/27151)
```
  // 统计阅读量与停留时间
  async saveInfo() {
    const stayTime = parseInt(this.outTime - this.enterTime);
    const token = this.$db.Get('token');
    const params = {
      token: token,
      time: stayTime, // 停留时间
      docId: this.articleId // 文章id
    };
    const rep = await this.POST(
      `${domain}/support/log/readWxMiniProgramDoc`,
      params
    );
  }
```
- 注意点

要统计停留时间，不可避免要涉及小程序页面的生命周期。

我的处理：

进入页面，onshow()

退出页面，分为 onHide()、onUnload()

```
onUnload() {
    let currOutTime = new Date();
    this.outTime = currOutTime;
    this.saveInfo();
  }
  onShow() {
    let currEnterTime = new Date();
    this.enterTime = currEnterTime;
  }
  onHide() {
    let currOutTime = new Date();
    this.outTime = currOutTime;
    this.saveInfo();
  }
```
#### 贝安学堂改造

之前这个模块内容是由前端写死的，这次 产品要求 根据用户的孕周 推送对应的文章。

主要难点：首页代码复杂，涉及接口等众多，在不破坏之前的逻辑基础上，不能给首页增加压力。

```
// getArticle()获取文章数据
async getArticle() {
    let articleResp = await this.GET(`/${khaosVersion}/getuserarticle`, {
      isMock: false
    });
    if (articleResp.result === 'success' && articleResp) {
      this.articleList = articleResp.data.map(item => {
        let articleDetailShow = item.articleDetail;
        if (articleDetailShow && item.articleDetail.length > 16) {
          articleDetailShow = item.articleDetail.substr(0, 16) + '...';
        }
        return Object.assign(item, {
          articleDetailShow: articleDetailShow,
          contentImg: JSON.stringify(item.content)
        });
      });
    }
    this.$broadcast('getBabySchoolArticle', this.articleList);
    this.$apply();
  }
```
通过broadcast方法，实现父子组件之间传值。

```
// 子组件
methods = {
    onAriticleDetail(id, type, title, content) {
      this.$link(
        `/sidePackage/pages/babySchoolDetail/babySchoolDetail?articleId=${
          id}&articleType=${type}&articleTitle=${title}&content=${content}`
      );
    }
  };
```

#### 一些优化

1、身份证空格处理：
输入身份证的时候，若有空格，自动将空格删除；

```
this.momCode.replace(/\s+/g, '')
```
2、异常提醒：
当报告状态异常时，进行显示以及样式提醒

```
<view class="card-wrap {{item.abnormal_state === 1 ? 'warn' : ''}}">

<text wx:if="{{item.abnormal_state === 1}}" class="red">（有异常）</text>
```
3、新增单号/条码长度校验

4、医护端对应内容的优化

### Thoughts
- 在这次工作中，发现了一些之前自己写的bug，虽然测试什么的都没发现。也及时改正了。
<b>所以呀，要努力变得更强大，少写bug 自己坑自己！
- 一直提醒自己要细心谨慎，但是这次又马虎了，甚至犯了单词错误 这种超低级错误，到上线才发现，造成不必要的精力损失。
- 深深反省中···